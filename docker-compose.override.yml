# This file extends the Astro docker-compose setup with additional services
# It will be automatically loaded by docker-compose when running astro dev start

services:
  # MLflow tracking server
  mlflow:
    image: python:3.11-slim
    command: >
      bash -c "pip install mlflow==3.0.1 psycopg2-binary boto3 && 
               export MLFLOW_S3_ENDPOINT_URL=http://minio:9000 &&
               mlflow server --host 0.0.0.0 --port 5001 
               --backend-store-uri postgresql://mlflow:mlflow@mlflow-db:5432/mlflow 
               --default-artifact-root s3://mlflow-artifacts/ 
               --serve-artifacts"
    # container_name: mlflow
    ports:
      - '5001:5001' 
    environment:
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      - mlflow-db
      - minio
    networks:
      - airflow
    # restart: unless-stopped

  # PostgreSQL for MLflow
  mlflow-db:
    image: postgres:12.6
    # container_name: mlflow-db
    environment:
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
      - AWS_DEFAULT_REGION=us-east-1
      - POSTGRES_USER=mlflow
      - POSTGRES_PASSWORD=mlflow
      - POSTGRES_DB=mlflow
    volumes:
      - docker_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'mlflow']
      interval: 5s
      retries: 5
    networks:
      - airflow
    # restart: unless-stopped

  # MinIO for S3-compatible storage
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    # container_name: minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - docker_minio_storage:/data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - airflow
    # restart: unless-stopped

  # Create MLflow bucket in MinIO
  minio-mc:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 10;
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/mlflow-artifacts || true;
      mc anonymous set public myminio/mlflow-artifacts;
      exit 0;
      "
    networks:
      - airflow


  # Add Redis to the Airflow network for Celery if needed
  # redis:
  #   image: redis:7.2-alpine
  #   container_name: redis
  #   restart: always
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #     - ./redis/redis.conf:/app/redis.conf:ro
  #   command: ["redis-server", "/app/redis.conf"]
  
  # Streamlit UI for model inference
  # streamlit-ui:
  #   image: python:3.11-slim
  #   platform: linux/arm64
  #   working_dir: /app
  #   command: >
  #     bash -c "
  #     apt-get update && apt-get install -y libgomp1 build-essential cmake &&
  #     pip install --no-cache-dir streamlit==1.29.0 pandas==2.1.4 numpy==1.24.3 scikit-learn==1.3.2 matplotlib==3.8.2 seaborn==0.13.0 plotly==5.18.0 mlflow==2.9.2 boto3==1.34.14 lightgbm==4.2.0 catboost==1.2.2 xgboost==2.0.3 &&
  #     chmod +x /app/entrypoint.sh &&
  #     /app/entrypoint.sh
  #     "
  #   ports:
  #     - '8501:8501'
  #   environment:
  #     - MLFLOW_TRACKING_URI=http://mlflow:5001
  #     - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
  #     - AWS_ACCESS_KEY_ID=minioadmin
  #     - AWS_SECRET_ACCESS_KEY=minioadmin
  #     - AWS_DEFAULT_REGION=us-east-1
  #   volumes:
  #     - ./ui:/app
  #     - ./include:/usr/local/airflow/include:ro
  #   depends_on:
  #     - mlflow
  #     - minio
  #   restart: unless-stopped


volumes:
  docker_postgres_data:
    name: docker_postgres_data
    external: true
  docker_minio_storage:
    name: docker_minio_storage
    external: true


networks:
  airflow:
    external: true
    name: sales-forecasting-mlops_955c54_airflow
  


# Ä‘eaults: 
# 34ea8ef7d1af   sales-forecasting-mlops_955c54/airflow:latest sales-forecasting-mlops_955c54-dag-processor-1
# 6350d58f5d8f   sales-forecasting-mlops_955c54/airflow:latest sales-forecasting-mlops_955c54-api-server-1
# 0b8d5881063c   sales-forecasting-mlops_955c54/airflow:latest sales-forecasting-mlops_955c54-triggerer-1
# 2b3df45044f6   sales-forecasting-mlops_955c54/airflow:latest sales-forecasting-mlops_955c54-scheduler-1
# fdc29d1b1a55   postgres:12.6                                 sales-forecasting-mlops_955c54-postgres-1